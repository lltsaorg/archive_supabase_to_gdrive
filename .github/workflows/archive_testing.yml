name: Archive to Drive (testing)

on:
  # Manual runs with test inputs
  workflow_dispatch:
    inputs:
      archive_test_days:
        description: "Test: use N days instead of months (empty to disable)"
        required: false
        default: ""
      archive_force_run:
        description: "Test: set 1/true to bypass first-day (empty/0=false)"
        required: false
        default: "0"
  # Optional: run on pushes to testing branch
  push:
    branches: [ "testing" ]

jobs:
  archive:
    # Ensure this workflow only runs on testing branch
    if: github.ref_name == 'testing'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install deps
        run: npm ci || npm i

      - name: Run archiver (always writes result.json)
        id: run
        continue-on-error: true
        run: node scripts/archive_multi_to_gdrive.js
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GCP_OAUTH_CLIENT_ID: ${{ secrets.GCP_OAUTH_CLIENT_ID }}
          GCP_OAUTH_CLIENT_SECRET: ${{ secrets.GCP_OAUTH_CLIENT_SECRET }}
          GOOGLE_OAUTH_REFRESH_TOKEN: ${{ secrets.GOOGLE_OAUTH_REFRESH_TOKEN }}
          GDRIVE_FOLDER_ID_TRANSACTIONS: ${{ secrets.GDRIVE_FOLDER_ID_TRANSACTIONS }}
          GDRIVE_FOLDER_ID_CHARGEREQUESTS: ${{ secrets.GDRIVE_FOLDER_ID_CHARGEREQUESTS }}
          # Archive period (months). Not a secret.
          # Defaults to 6 if unset.
          CUTOFF_MONTHS_DEFAULT: ${{ vars.CUTOFF_MONTHS_DEFAULT }}
          # Test mode: allow inputs, fallback to repository vars
          ARCHIVE_TEST_DAYS: ${{ github.event.inputs.archive_test_days || vars.ARCHIVE_TEST_DAYS }}
          ARCHIVE_FORCE_RUN: ${{ github.event.inputs.archive_force_run || vars.ARCHIVE_FORCE_RUN }}

      - name: Parse executed flag
        id: parse
        run: |
          EXECUTED=$(node -e "const fs=require('fs');let j={};try{j=JSON.parse(fs.readFileSync('result.json','utf8'))}catch{};process.stdout.write(j.executed?'true':'false');")
          echo "executed=$EXECUTED" >> $GITHUB_OUTPUT

      - name: Send Gmail notification (only if executed)
        if: steps.parse.outputs.executed == 'true'
        run: node scripts/send_gmail.js result.json
        env:
          GMAIL_CLIENT_ID: ${{ secrets.GMAIL_CLIENT_ID }}
          GMAIL_CLIENT_SECRET: ${{ secrets.GMAIL_CLIENT_SECRET }}
          GMAIL_REFRESH_TOKEN: ${{ secrets.GMAIL_REFRESH_TOKEN }}
          GMAIL_SENDER: ${{ secrets.GMAIL_SENDER }}
          NOTIFY_EMAIL: ${{ secrets.NOTIFY_EMAIL }}

